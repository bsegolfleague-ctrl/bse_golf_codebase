<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Scorecard</title>
<script src="https://cdn.tailwindcss.com"></script>

<script type="module" src="config.js"></script>
<style>
.toast {
  position: fixed; bottom: 20px; right: 20px;
  background: #333; color: #fff; padding: 10px 20px;
  border-radius: 5px; opacity: 0.9; z-index: 9999;
  font-family: Arial, sans-serif;
}
.toast-success { background: green; }
.toast-error { background: red; }
.toast-info { background: #333; }
</style>

</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
<h1 class="text-3xl font-bold text-gray-800 mb-6">Scorecard</h1>
<div class="w-full max-w-3xl overflow-x-auto bg-white p-4 rounded-2xl shadow-lg">
<div id="scorecard"></div>
</div>
<button class="w-full max-w-3xl mt-4 py-4 text-white font-semibold text-lg rounded-xl bg-gradient-to-r from-green-500 to-teal-400 shadow-lg hover:scale-105 hover:shadow-xl transition-transform duration-300" id="saveBtn">
    Save Round
  </button>
<script type="module">
  import { addRoundDoc } from './config.js';
    // Load setup info from setup.html
    const setup = JSON.parse(localStorage.getItem("roundSetup"));
    if (!setup || !setup.players || setup.players.length === 0) {
      alert("No players selected. Redirecting to setup page.");
      window.location.href = "setup.html";
    }

    const holes = parseInt(setup.holes);
    const container = document.getElementById("scorecard");

    // Build table HTML
    let html = `<table class="table-auto border-collapse w-full text-center text-sm min-w-max">
      <thead>
        <tr>
          <th class="border p-2 bg-gray-100">Player</th>`;
    for (let i = 1; i <= holes; i++) html += `<th class="border p-2 bg-gray-100">H${i}</th>`;
    html += `<th class="border p-2 bg-gray-100">Total</th><th class="border p-2 bg-gray-100">To Par</th></tr></thead><tbody>`;

    // Par row
    html += `<tr class="bg-gray-50"><td class="border p-2 font-bold">Par</td>`;
    for (let i = 1; i <= holes; i++) {
      html += `<td class="border p-1">
                 <input type="number" class="w-14 p-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400 focus:outline-none par" data-hole="${i}">
               </td>`;
    }
    html += `<td class="border">—</td><td class="border">—</td></tr>`;

    // Player rows
    setup.players.forEach(player => {
      html += `<tr class="hover:bg-gray-50 transition-colors"><td class="border p-2 font-semibold">${player}</td>`;
      for (let i = 1; i <= holes; i++) {
        html += `<td class="border p-1">
                  <input type="number" class="w-14 p-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400 focus:outline-none score" data-player="${player}" data-hole="${i}">
                 </td>`;
      }
      html += `<td class="border total" data-player="${player}">0</td>`;
      html += `<td class="border toPar" data-player="${player}">0</td></tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;

    // Live totals
    function updateTotals() {
      const pars = {};
      document.querySelectorAll(".par").forEach(p => pars[p.dataset.hole] = parseInt(p.value) || 0);

      setup.players.forEach(player => {
        let total = 0, totalPar = 0;
        document.querySelectorAll(`.score[data-player="${player}"]`).forEach(s => {
          const score = parseInt(s.value) || 0;
          total += score;
          totalPar += pars[s.dataset.hole] || 0;
        });
        document.querySelector(`.total[data-player="${player}"]`).textContent = total;
        document.querySelector(`.toPar[data-player="${player}"]`).textContent = totalPar ? total - totalPar : "";
      });
    }

    document.addEventListener("input", e => {
      if (e.target.classList.contains("score") || e.target.classList.contains("par")) updateTotals();
    });

    // Save to Firestore
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const pars = {};
      document.querySelectorAll(".par").forEach(p => pars[p.dataset.hole] = parseInt(p.value) || 0);

      for (const player of setup.players) {
        let payload = {
          Date: new Date().toISOString().split("T")[0],
          Course: setup.course,
          Player: player
        };
        let total = 0, totalPar = 0;

        for (let i = 1; i <= holes; i++) {
          payload[`Par${i}`] = pars[i] || "";
          const scoreInput = document.querySelector(`.score[data-player="${player}"][data-hole="${i}"]`);
          const score = parseInt(scoreInput.value) || 0;
          payload[`Score${i}`] = score || "";
          total += score;
          totalPar += pars[i] || 0;
        }
        payload.Total = total;
        payload.ToPar = totalPar ? total - totalPar : "";

        await addRoundDoc(payload);
      }

      alert("Round saved!");
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
